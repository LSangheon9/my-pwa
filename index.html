<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>Mint</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
:root{
  --bg:#0b0f14; --panel:#0f141b; --text:#eef3ff; --muted:#9aa5b1; --bd:#1a2230;
  --acc:#5f96ff; --acc2:#b486ff; --ok:#2ddaa5; --bad:#ff6d7a; --chip:#121a24; --chipbd:#223047;
}
*{box-sizing:border-box; min-width:0}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
     font:15.5px/1.95 -apple-system,system-ui,"Noto Sans KR","Noto Sans","Malgun Gothic",Roboto,Arial;
     -webkit-text-size-adjust:100%; max-width:100vw}
a{color:#9fbaff; text-decoration:none}
.wrap{max-width:920px;margin:0 auto;padding:14px}
.panel{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:12px}
.titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.blogo{width:14px;height:14px;border-radius:6px;background:conic-gradient(from 180deg,var(--acc),var(--acc2),var(--acc))}
.btn{display:inline-flex;align-items:center;justify-content:center;
     background:linear-gradient(180deg,var(--acc),var(--acc2));color:#fff;border:0;border-radius:12px;
     padding:9px 12px;font-size:14px;font-weight:800;min-height:36px;cursor:pointer;
     white-space:nowrap; max-width:100%; overflow:hidden; text-overflow:ellipsis}
.btn.ghost{background:transparent;color:#9fbaff;border:1px solid var(--chipbd)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input[type="text"],input[type="password"],select{background:var(--chip);color:var(--text);border:1px solid var(--chipbd);
   border-radius:12px;padding:8px 11px;font-size:14px;outline:none;min-width:0}
textarea{width:100%;height:240px;background:var(--chip);color:var(--text);border:1px solid var(--chipbd);
   border-radius:12px;padding:12px;font-size:15.5px;font-family:"Noto Sans KR","Noto Sans","Malgun Gothic",Roboto,Arial; line-height:1.9; white-space:pre-wrap}
.tiny{font-size:12px;color:var(--muted)}
.badger{font-size:10px;color:#86a1ff}
.divider{height:1px;background:var(--bd);margin:14px 0}
.choices{display:grid; grid-template-columns:1fr 1fr; gap:8px}
@media (min-width:860px){ .choices{ grid-template-columns:1fr 1fr 1fr; } }
.chip{border:1px solid var(--chipbd);background:var(--chip);border-radius:12px;padding:8px 10px;
      font-size:16px;line-height:1.25; text-align:center; min-height:36px;
      white-space:nowrap; word-break:keep-all; overflow:hidden; text-overflow:ellipsis}
.chip.ok{border-color:var(--ok);box-shadow: inset 0 0 0 2px var(--ok)}
.chip.no{border-color:var(--bad);box-shadow: inset 0 0 0 2px var(--bad)}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--chipbd);
       padding:3px 8px;border-radius:999px;background:var(--chip);font-size:10.5px}
.dot{width:7px;height:7px;border-radius:999px;background:#777}
.okc{background:var(--ok)} .badc{background:var(--bad)}
.qwrap{display:flex;flex-direction:column;gap:8px}
.qtitle{font-weight:800;font-size:17px}
.qpassage{white-space:pre-wrap; line-height:2.05; letter-spacing:.05px; font-size:17px; border:1px solid var(--chipbd);
          background:var(--chip); border-radius:12px; padding:12px; height:38vh; overflow:auto}
.qpassage mark{background:transparent; color:#fff; border-bottom:3px solid var(--acc2); padding:0 2px}
.qfooter{display:flex;align-items:center;justify-content:space-between}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111a;color:#fff;border:1px solid var(--chipbd);
       border-radius:999px;padding:10px 16px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:9999}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
/* screens */
.screen{display:none}
.screen.show{display:block}
.list{display:grid; grid-template-columns:1fr; gap:10px}
.card{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--chipbd);background:var(--chip);
      border-radius:12px;padding:10px}
.card .meta{display:flex; flex-direction:column; gap:4px}
/* compact topbar on quiz screen */
.topbar{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.topbar .left{display:flex; gap:10px; align-items:center}
.topbtn{display:inline-flex;align-items:center;justify-content:center;
        background:transparent;border:1px solid var(--chipbd);color:#9fbaff;border-radius:10px;padding:6px 10px; font-size:13px;
        white-space:nowrap; max-width:100%; overflow:hidden; text-overflow:ellipsis}

/* modal */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9998}
.modal.show{display:flex}
.modal .box{background:var(--panel); border:1px solid var(--bd); border-radius:14px; padding:16px; width:min(92vw,520px)}
.gallery{display:none; position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:9997; align-items:center; justify-content:center; flex-direction:column; padding:12px}
.gallery.show{display:flex}
.gallery img{ max-width:92vw; max-height:72vh; border-radius:12px; border:1px solid var(--chipbd); background:#000 }
.gallery .gctrl{ display:flex; gap:8px; margin-top:10px }
</style>
</head>
<body>
<div class="wrap">

  <!-- HOME -->
  <div id="home" class="screen show">
    <div class="panel">
      <div class="titlebar">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="blogo"></div>
          <b>Mint</b>
        </div>
        <button id="newFromHome" class="btn" type="button">+ New</button>
      </div>
      <div class="tiny">저장된 노트</div>
      <div id="homeList" class="list" style="margin-top:6px"></div>
      <div id="homeEmpty" class="tiny" style="color:#94a3b8;margin-top:8px">아직 저장된 노트가 없습니다.</div>
    </div>
  </div>

  <!-- EDIT -->
  <div id="edit" class="screen">
    <div class="panel">
      <div class="titlebar">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="goHome1" class="btn ghost" type="button">홈</button>
          <b id="brand">Mint</b>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="badge"><span id="gptDot" class="dot"></span><span id="gptTxt">GPT 꺼짐</span></span>
          <button id="deleteBtn" class="btn ghost" type="button">삭제</button>
          <button id="saveBtn" class="btn ghost" type="button">저장</button>
          <button id="genBtn" class="btn" type="button">생성</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <input id="title" type="text" placeholder="제목 입력(상단 바에는 표시만 됨)" style="min-width:220px;flex:1">
      </div>

      <div class="row tiny" id="imgRow" style="display:none">
        <input id="imgInput" type="file" accept="image/*" multiple>
        <span class="tiny" id="imgCount" style="color:#94a3b8">첨부된 이미지 0장</span>
      </div>

      <textarea id="src" placeholder="텍스트를 붙여넣고 ‘생성’을 누르세요. (줄바꿈과 **볼드** 그대로 유지합니다)"></textarea>

      <div class="divider"></div>

      <!-- 설정 -->
      <div class="row tiny" style="gap:14px">
        <label><input id="autoTune" type="checkbox" checked> 자동설정(길이 기반)</label>
        <label><input id="proLocal" type="checkbox" checked> 고급 로컬 엔진+</label>
        <label><input id="snippetMode" type="checkbox"> 스니펫 모드(양쪽 맥락)</label>
      </div>
      <div class="row tiny">최대 문제 수 <input id="holes" type="number" value="24" min="4" max="200" style="width:80px"> 개</div>
      <div class="row tiny">문장당 최대 빈칸 (상한)<input id="perSent" type="number" value="3" min="1" max="6" style="width:80px"> 개</div>
      <div class="row tiny">선택지 개수 <input id="nchoice" type="number" value="4" min="2" max="6" style="width:80px"> 개</div>
      <div class="row tiny">
        <label><input id="useLLM" type="checkbox"> ChatGPT 사용 (맥락 강화)</label>
        <input id="llmKey" type="password" placeholder="OpenAI API 키" style="flex:1; min-width:220px">
        <select id="llmModel">
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
          <option value="gpt-4o-mini">gpt-4o-mini</option>
        </select>
      </div>
      <div id="autoNote" class="tiny" style="color:#94a3b8"></div>

      <div class="divider"></div>

      <!-- 미리보기 -->
      <div class="qwrap">
        <div class="qtitle">문제 프리뷰</div>
        <div id="qpassagePreview" class="qpassage">여기에 빈칸 지문이 표시됩니다.</div>
        <div class="choices" id="choicesPreview"></div>
        <div class="qfooter tiny"><span id="diag">상태: 준비</span><span id="statsPreview"></span></div>
      </div>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="screen">
    <div class="panel">
      <div class="topbar">
        <div class="left">
          <button id="goHome2" class="topbtn" type="button">홈</button>
          <button id="backToEdit" class="topbtn" type="button">설정</button>
          <button id="saveRun" class="topbtn" type="button">진행 저장</button>
          <button id="showGallery" class="topbtn" type="button">이미지</button>
        </div>
        <b id="quizTitle">Mint</b>
      </div>
      <div class="qwrap">
        <div id="qpassage" class="qpassage"></div>
        <div class="choices" id="choices"></div>
        <div class="qfooter tiny"><span id="stats"></span><span id="progress"></span></div>
      </div>
    </div>
  </div>

</div>

<!-- NEW NOTE MODAL -->
<div id="newModal" class="modal">
  <div class="box">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
      <b>새 노트 만들기</b>
      <button id="closeNew" class="btn ghost" type="button">닫기</button>
    </div>
    <div class="tiny" style="margin-bottom:8px">사진을 첨부할지 선택하세요.</div>
    <div class="row">
      <button id="newTextOnly" class="btn" type="button">텍스트만</button>
      <button id="newWithImages" class="btn" type="button">사진 첨부</button>
    </div>
  </div>
</div>

<!-- IMAGE GALLERY -->
<div id="gallery" class="gallery">
  <img id="gimg" alt="image">
  <div class="gctrl">
    <button id="gprev" class="btn ghost" type="button">이전</button>
    <button id="gnext" class="btn ghost" type="button">다음</button>
    <button id="gclose" class="btn ghost" type="button">닫기</button>
  </div>
</div>

<div id="toast" class="toast">완료</div>

<script>
(function(){
'use strict';
const $=id=>document.getElementById(id);
const screens={home:$('home'), edit:$('edit'), quiz:$('quiz')};
function show(name){ for(const k in screens){ screens[k].classList.toggle('show', k===name); } }

// ----- State -----
let RAW="", QUE=[], TOTAL=0, CORR=0, WRONG=[], currentId=null, sessionId=null;
let images=[], galleryIdx=0, allowImages=false;
const titleEl=$('title'), brand=$('brand'), quizTitle=$('quizTitle'), src=$('src');
const qpassage=$('qpassage'), qpassagePreview=$('qpassagePreview'), choices=$('choices'), choicesPreview=$('choicesPreview');
const stats=$('stats'), progress=$('progress'), statsPreview=$('statsPreview'), diag=$('diag');
const gptDot=$('gptDot'), gptTxt=$('gptTxt');
function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1100); }
function setDiag(t){ diag.textContent='상태: '+t; }
function updateGPTBadge(){const on=$('useLLM').checked && !!$('llmKey').value.trim(); gptDot.className='dot '+(on?'okc':'badc'); gptTxt.textContent=on?'GPT 켜짐':'GPT 꺼짐';}
$('useLLM').addEventListener('change',updateGPTBadge); $('llmKey').addEventListener('input',updateGPTBadge); updateGPTBadge();

// ----- Home List -----
function getIndex(){ try{ return JSON.parse(localStorage.getItem('notes_index')||'[]')||[]; }catch(e){ return []; } }
function setIndex(arr){ localStorage.setItem('notes_index', JSON.stringify(arr||[])); }
function hasSession(noteId){ return !!localStorage.getItem('session_'+noteId); }
function renderHome(){
  const list=$('homeList'), empty=$('homeEmpty');
  const idx=getIndex().sort((a,b)=>(b.updated||b.created)-(a.updated||a.created));
  list.innerHTML='';
  if(!idx.length){ empty.style.display='block'; } else { empty.style.display='none'; }
  idx.forEach(n=>{
    const wrap=document.createElement('div'); wrap.className='card';
    const meta=document.createElement('div'); meta.className='meta';
    const line1=document.createElement('div'); line1.innerHTML=`<b>${escapeHtml(n.title||'(제목 없음)')}</b>`;
    meta.append(line1);
    if(hasSession(n.id)){
      const line2=document.createElement('div'); line2.className='tiny'; line2.textContent='(이어하기 있음)';
      meta.append(line2);
    }
    const right=document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
    const open=document.createElement('button'); open.className='btn ghost'; open.textContent='열기'; open.onclick=()=>openNote(n.id);
    const cont=document.createElement('button'); cont.className='btn ghost'; cont.textContent='이어하기'; cont.onclick=()=>resumeSession(n.id); cont.style.display= hasSession(n.id)?'inline-flex':'none';
    const del=document.createElement('button'); del.className='btn ghost'; del.textContent='삭제'; del.onclick=()=>deleteNote(n.id);
    right.append(open,cont,del);
    wrap.append(meta,right);
    list.append(wrap);
  });
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function safeRich(s){
  let out=escapeHtml(s||"");
  out=out.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  out=out.replace(/&lt;(b|strong)&gt;/gi,'<$1>').replace(/&lt;\/(b|strong)&gt;/gi,'</$1>');
  return out;
}

// ----- Save / Open / Delete -----
function saveNote(){
  const title=titleEl.value.trim()||'(제목 없음)'; const content=src.value;
  if(!content.trim()){ alert('내용이 비어 있습니다.'); return; }
  let id=currentId; const now=Date.now(); if(!id){ id='n'+now+Math.random().toString(16).slice(2); currentId=id; }
  const rec={id,title,content,images,allowImages,created:now,updated:now,size:content.length};
  localStorage.setItem('note_'+id, JSON.stringify(rec));
  const idx=getIndex().filter(x=>x.id!==id); idx.push({id,title,created:rec.created,updated:rec.updated,size:rec.size,imgCount:images.length});
  setIndex(idx); toast('저장됨'); renderHome();
}
function deleteNote(id){
  if(!id){ alert('삭제할 항목이 없습니다.'); return; }
  if(!confirm('삭제할까요?')) return;
  localStorage.removeItem('note_'+id);
  localStorage.removeItem('cloze_wrong_'+id);
  localStorage.removeItem('session_'+id);
  const idx=getIndex().filter(x=>x.id!==id); setIndex(idx);
  if(currentId===id){ currentId=null; titleEl.value=''; src.value=''; images=[]; $('imgCount').textContent='첨부된 이미지 0장'; }
  renderHome(); toast('삭제됨');
}
function openNote(id){
  const rec=JSON.parse(localStorage.getItem('note_'+id)||'null');
  if(!rec){ alert('노트를 찾을 수 없습니다.'); return; }
  currentId=id; titleEl.value=rec.title||''; src.value=rec.content||'';
  images=rec.images||[]; allowImages=!!rec.allowImages;
  RAW=""; QUE=[]; TOTAL=0; CORR=0; WRONG=[];
  $('imgRow').style.display = allowImages? 'flex':'none';
  $('imgCount').textContent = `첨부된 이미지 ${images.length}장`;
  brand.textContent=rec.title||'Mint'; quizTitle.textContent=brand.textContent;
  qpassagePreview.textContent='여기에 빈칸 지문이 표시됩니다.'; choicesPreview.innerHTML=''; statsPreview.textContent='';
  setDiag('노트 로드됨'); show('edit');
}
$('deleteBtn').onclick=()=>{ if(currentId){ deleteNote(currentId); show('home'); } else { alert('현재 노트가 없습니다.'); } };

// ----- Session (autosave/restore) -----
function makeSessionId(){
  if(currentId) return 'session_'+currentId;
  const t=(titleEl.value||'').slice(0,64), c=(src.value||'').slice(0,256);
  let h=0, s=t+'|'+c; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return 'session_tmp_'+(h>>>0);
}
function saveSession(){
  if(!RAW || !QUE) return;
  sessionId = makeSessionId();
  const payload={ id:sessionId, noteId:currentId||null, title:titleEl.value||'Mint', raw:RAW, que:QUE, total:TOTAL, corr:CORR,
                  nchoice:+$('nchoice').value||4, ts:Date.now(), images, allowImages };
  try{ localStorage.setItem(sessionId, JSON.stringify(payload)); toast('진행 저장됨'); }catch(e){}
}
function clearSession(){ if(!sessionId) sessionId=makeSessionId(); localStorage.removeItem(sessionId); }
function tryResumePrompt(){
  const key=currentId? 'session_'+currentId : makeSessionId();
  const s=localStorage.getItem(key);
  if(!s) return false;
  if(confirm('이전에 진행하던 문제가 있습니다. 이어서 할까요?')){
    const payload=JSON.parse(s);
    RAW=payload.raw; QUE=payload.que||[]; TOTAL=payload.total||0; CORR=payload.corr||0;
    images=payload.images||[]; allowImages=payload.allowImages;
    brand.textContent=payload.title||'Mint'; quizTitle.textContent=payload.title||'Mint';
    show('quiz'); renderNext(); setTimeout(()=>toast('이어하기 로드됨'), 10);
    return true;
  }
  return false;
}
function resumeSession(noteId){
  const s=localStorage.getItem('session_'+noteId);
  if(!s){ alert('이어할 세션이 없습니다.'); return; }
  const payload=JSON.parse(s);
  currentId=noteId;
  titleEl.value=payload.title||''; src.value=payload.raw||'';
  RAW=payload.raw; QUE=payload.que||[]; TOTAL=payload.total||0; CORR=payload.corr||0;
  images=payload.images||[]; allowImages=payload.allowImages;
  brand.textContent=payload.title||'Mint'; quizTitle.textContent=payload.title||'Mint';
  show('quiz'); renderNext(); toast('이어하기 로드됨');
}

// ===== Cloze Engine v28f-balance (only method changed) =====
const STOP=new Set((`가 각 또한 그리고 그러나 그래서 그런데 또는 및 즉 따라서 하지만 이는 이를 이가 그의 그녀 그들
은 는 이 가 을 를 의 에 에서 으로 와 과 도 만 보다 처럼 대해 대한 대해서 등이 등등 있다 없다 하다 되다 a an the and or but so of to in on at for with from by as is are was were be been being this that those these it its their them they he she we you`).trim().split(/\s+/));

const JOSA=['으로써','으로서','이지만','지만','이라도','라도','이나','나','이며','에서','에게','께서','부터','까지','처럼','보다','만큼','조차','마저','밖에','으로','로','이고','이며','과','와','을','를','은','는','이','가','의','도','만','랑','하고','동안','후에','이후','이전에','때','동안에'];
const VERB_END=['한다','된다','하였다','했다','하며','하여','하면','하도록','되고','되며','되면','되어','되는','시키다','시킨다','촉진한다','억제한다','유발한다','형성한다','전달한다','합성한다','분해한다','저장한다','흡수한다','분비한다','유리한다','전환한다','증가한다','감소한다'];
const PROCESS_HINT=/촉진|억제|유발|형성|전달|합성|분해|저장|흡수|분비|유리|전환|조절|변화|증가|감소|유지/;
const WHY_HINT=/왜|이유|원인|때문|결과적으로|그 결과|따라서|그래서|결국/;
const HOW_HINT=/어떻게|방식|방법|절차|경로|수단|과정을 통해|하여|함으로써|촉진|억제|조절|유발|형성|전달|합성|분해|진행/;
const WHEN_HINT=/언제|초기|중기|말기|동안|이후|이전에|후에|\d{1,4}\s*(년|월|일|시|분)|봄|여름|가을|겨울/;
const WHERE_HINT=/어디서|어디에서|위치|부위|영역|장기|조직|내에서|밖에서|핵|세포질|혈액|혈관|간|췌장|근육|뇌/;
const WHO_HINT=/누가|어떤 세포|어떤 호르몬|효소|단백질|기관|조직|세포/;

function sentencesIdx(text){
  const seps=/[\.?!\n\r。！？…]/g;
  const idxs=[0]; let m;
  while((m=seps.exec(text))){ idxs.push(m.index+1); }
  idxs.push(text.length);
  const out=[];
  for(let i=0;i<idxs.length-1;i++){
    const s=idxs[i], e=idxs[i+1];
    if(e-s<2) continue;
    out.push([s,e]);
  }
  return out;
}
function stripPunct(t){ return t.replace(/^[\s\"'“”‘’()\[\]{},.?!;:]+|[\s\"'“”‘’()\[\]{},.?!;:]+$/g,''); }
function stripJosa(w){
  let t=stripPunct(w);
  const sorted=[...JOSA].sort((a,b)=>b.length-a.length);
  for(const s of sorted){
    if(t.length>s.length && t.endsWith(s)){ t=t.slice(0,-s.length); break; }
  }
  return t;
}
function stripVerbEnding(w){
  let t=w;
  const sorted=[...VERB_END].sort((a,b)=>b.length-a.length);
  for(const s of sorted){ if(t.length>s.length && t.endsWith(s)){ t=t.slice(0,-s.length); break; } }
  if(t.endsWith('하다')) t=t.slice(0,-2);
  if(t.length<=1) t=w;
  return t;
}
function tokenizeWithPos(text, offset){
  const out=[];
  const re=/[^\s]+/g;
  let m;
  while((m=re.exec(text))){
    const raw=m[0];
    out.push({raw,start:offset+m.index,end:offset+m.index+raw.length});
  }
  return out;
}
function genCandidates(tokens){
  const out=[];
  for(const t of tokens){
    let base=stripJosa(t.raw);
    base=stripVerbEnding(base);
    const k=base.toLowerCase();
    if(!base || base.length<2) continue;
    if(/\d/.test(k)) continue;
    if(STOP.has(k)) continue;
    out.push({raw:t.raw, base, start:t.start, end:t.end});
  }
  return out;
}
function scoreWord(globalText, sentText, sentStart, cand){
  const L=140,R=160;
  const ctx = globalText.slice(Math.max(0,cand.start-L), Math.min(globalText.length, cand.end+R));
  let s=0;
  // 길이/명사 가중
  s += Math.min(1.6, Math.log2(cand.base.length+1)/1.3);
  // 과정·행위
  if(PROCESS_HINT.test(cand.base)) s+=0.7;
  // 5W1H 문맥
  if(WHY_HINT.test(ctx))  s+=1.2;
  if(HOW_HINT.test(ctx))  s+=1.2;
  if(WHEN_HINT.test(ctx)) s+=1.0;
  if(WHERE_HINT.test(ctx))s+=1.0;
  if(WHO_HINT.test(ctx))  s+=0.8;
  // 연결어/순서 신호
  if(/그래서|따라서|결과적으로|그 결과|이를 통해|먼저|다음으로|마지막으로/.test(sentText)) s+=0.6;
  // 문장 머리 번호/라벨
  const headBefore = globalText.slice(sentStart, cand.start);
  if(/^\s*(\d{1,3}[\.|)]|\([0-9]{1,3}\)|[A-Za-z][\.|)]|\([A-Za-z]\))/.test(headBefore.trimStart())) s+=0.5;
  // 미세 랜덤
  s += Math.random()*0.08;
  return s;
}

// --- 핵심 변경: 문장별 상위 후보를 뽑고, 라운드로빈으로 합치기 (연속 개념 편중 방지 + 전 문장 커버) ---
function chooseBalanced(text, hardMax, perSentCap){
  const sents = sentencesIdx(text);
  const per = []; // 각 문장 큐
  for(let si=0; si<sents.length; si++){
    const [s,e]=sents[si];
    const sentText = text.slice(s,e);
    const toks = tokenizeWithPos(sentText, s);
    const cands  = genCandidates(toks);
    const scored = cands.map(p=>({...p,score:scoreWord(text, sentText, s, p)}))
                        .sort((a,b)=>b.score-a.score || a.start-b.start);
    // 문장당 상위 N만
    per.push(scored.slice(0, Math.max(1, perSentCap)));
  }
  // 라운드로빈 머지
  const merged=[];
  let added=0, ptr=0;
  const totalS = per.length;
  while(added<hardMax){
    let progressed=false;
    for(let k=0;k<totalS;k++){
      const si=(ptr+k)%totalS;
      if(per[si] && per[si].length){
        const it=per[si].shift();
        merged.push({answer:it.base,pos:it.start,len:it.base.length,rawSpan:[it.start,it.end], sentIdx:si});
        added++; progressed=true;
        if(added>=hardMax) break;
      }
    }
    if(!progressed) break;
    ptr++;
  }
  // 중복 허용하되, 같은 정답이 즉시 연속되지 않도록 뒤에서 조정
  return merged;
}

function buildDistractors(allItems){
  const bases=[...new Set(allItems.map(it=>it.answer))];
  function dsPool(ans){
    const al=ans.length;
    const pool=bases.filter(b=>b!==ans && Math.abs(b.length-al)<=Math.max(2,Math.floor(al*0.4)));
    return pool;
  }
  return allItems.map(it=>{
    const pool=dsPool(it.answer).sort(()=>Math.random()-0.5);
    return {...it, distractors:pool.slice(0,3)};
  });
}
function deStreak(items, window=2){
  const arr=items.slice();
  for(let i=1;i<arr.length;i++){
    if(arr[i].answer===arr[i-1].answer){
      // 가까운 범위 내 다른 정답과 교체
      let swapped=false;
      for(let j=i+1;j<Math.min(arr.length, i+1+8);j++){
        if(arr[j].answer!==arr[i].answer){
          const tmp=arr[i]; arr[i]=arr[j]; arr[j]=tmp; swapped=true; break;
        }
      }
      if(!swapped){
        for(let k=i-2;k>=0;k--){
          if(arr[k].answer!==arr[i].answer){ const t=arr[i]; arr[i]=arr[k]; arr[k]=t; break; }
        }
      }
    }
  }
  return arr;
}

function renderRichWithBlank(raw, item, snippet){
  const before = raw.slice(0, item.pos);
  const after  = raw.slice(item.pos + item.len);
  function safe(s){
    let out=s.replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    out=out.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    out=out.replace(/&lt;(b|strong)&gt;/gi,'<$1>').replace(/&lt;\/(b|strong)&gt;/gi,'</$1>');
    return out;
  }
  if(snippet){
    const L=260,R=280;
    const pre = before.slice(-L);
    const post = after.slice(0,R);
    const preEll = before.length>pre.length ? '…' : '';
    const postEll = after.length>post.length ? '…' : '';
    return preEll + safe(pre) + '<mark>____</mark>' + safe(post) + postEll;
  }else{
    return safe(before) + '<mark>____</mark>' + safe(after);
  }
}
function renderChoices(container, item, nChoice, onPick){
  container.innerHTML='';
  const opts=[item.answer, ...item.distractors].sort(()=>Math.random()-0.5).slice(0, Math.max(2,nChoice));
  for(const opt of opts){
    const el=document.createElement('div'); el.className='chip'; el.textContent=opt;
    el.onclick=()=>{
      if(opt===item.answer){ el.classList.add('ok'); }
      else{
        el.classList.add('no');
        [...container.children].forEach(n=>{ if(n.textContent===item.answer) n.classList.add('ok'); });
      }
      setTimeout(()=>onPick(opt===item.answer), 160);
    };
    container.appendChild(el);
  }
}

// ----- Quiz Flow -----
function startQuiz(wrongOnly=false){
  const text=src.value.trim(); if(!text){ alert('텍스트를 넣어주세요.'); return; }
  RAW=text; TOTAL=0; CORR=0; WRONG=[];
  const title=titleEl.value.trim()||'Mint'; brand.textContent=title; quizTitle.textContent=title;
  sessionId=null;
  if(tryResumePrompt()) return;

  if($('autoTune').checked){
    const len=RAW.length;
    const holes = len<600? 18 : len<1200? 28 : len<2400? 40 : 60;
    $('holes').value=holes;
  }

  const hardMax = Math.max(4, Math.min(200, +$('holes').value||24));
  const perSentCap = Math.max(1, Math.min(6, +$('perSent').value||3));
  const nChoice = Math.max(2, Math.min(6, +$('nchoice').value||4));

  setDiag('문항 구성(밸런스)…');

  let items = chooseBalanced(RAW, hardMax, perSentCap);
  if(!items.length){ alert('만들 수 있는 문항이 없습니다.'); return; }

  items = buildDistractors(items);
  items = deStreak(items, 2);

  qpassagePreview.innerHTML = renderRichWithBlank(RAW, items[0], $('snippetMode').checked);
  renderChoices(choicesPreview, items[0], nChoice, ()=>{});
  $('statsPreview').textContent=`미리보기 · 총 ${items.length}문항`;

  QUE = items;
  show('quiz'); renderNext();
}
function renderNext(){
  const nChoice = Math.max(2, +$('nchoice').value||4);
  if(!QUE.length){
    $('qpassage').innerHTML='<b>끝!</b>'; $('stats').textContent=`점수 ${CORR}/${TOTAL}`; $('progress').textContent=''; clearSession(); return;
  }
  const cur=QUE[0];
  const useSnippet = $('snippetMode').checked;
  const qp = $('qpassage');

  qp.innerHTML = renderRichWithBlank(RAW, cur, useSnippet);

  const mark = qp.querySelector('mark');
  if(mark){
    const top = mark.offsetTop - (qp.clientHeight/2) + 24;
    qp.scrollTo({top: Math.max(0, top)});
  }

  renderChoices($('choices'), cur, nChoice, (correct)=>{
    TOTAL++; if(correct) CORR++; else WRONG.push(cur);
    QUE.shift(); updateProg(); saveSession(); renderNext();
  });
  updateProg(); saveSession();
}
function updateProg(){ $('stats').textContent=`정답 ${CORR} / 시도 ${TOTAL}`; $('progress').textContent=`남은 ${QUE.length}`; }

// ----- Image attach & gallery -----
$('imgInput').addEventListener('change', async (e)=>{
  const files=[...e.target.files];
  for(const f of files){
    const b=await f.arrayBuffer();
    const base64 = 'data:'+ (f.type||'image/*') + ';base64,' + arrayBufferToBase64(b);
    images.push({name:f.name, data:base64, type:f.type});
  }
  $('imgCount').textContent = `첨부된 이미지 ${images.length}장`;
  toast('이미지 첨부됨');
});
function arrayBufferToBase64(buffer){
  let binary=''; const bytes=new Uint8Array(buffer);
  const len=bytes.byteLength; for(let i=0;i<len;i++){ binary += String.fromCharCode(bytes[i]); }
  return btoa(binary);
}
$('showGallery').onclick=()=>{
  if(!allowImages || !images.length){ alert('첨부된 이미지가 없습니다.'); return; }
  galleryIdx = Math.max(0, Math.min(galleryIdx, images.length-1));
  showGalleryIdx(galleryIdx);
  $('gallery').classList.add('show');
};
$('gclose').onclick=()=>$('gallery').classList.remove('show');
$('gprev').onclick=()=>{ if(images.length){ galleryIdx=(galleryIdx-1+images.length)%images.length; showGalleryIdx(galleryIdx);} };
$('gnext').onclick=()=>{ if(images.length){ galleryIdx=(galleryIdx+1)%images.length; showGalleryIdx(galleryIdx);} };
function showGalleryIdx(i){
  const cur=images[i]; if(!cur) return;
  $('gimg').src=cur.data; $('gimg').alt=cur.name||('image '+(i+1));
}

// ----- Navigation -----
function newNoteCore(withImages){
  currentId=null; titleEl.value=''; src.value=''; RAW=""; QUE=[]; TOTAL=0; CORR=0; WRONG=[]; sessionId=null;
  images=[]; allowImages=!!withImages;
  $('imgRow').style.display = allowImages? 'flex':'none';
  $('imgCount').textContent = '첨부된 이미지 0장';
  qpassagePreview.textContent='여기에 빈칸 지문이 표시됩니다.'; choicesPreview.innerHTML=''; statsPreview.textContent='';
  brand.textContent='Mint'; quizTitle.textContent='Mint'; setDiag('새 노트');
  show('edit');
}
function newNote(){ $('newModal').classList.add('show'); }
$('newTextOnly').onclick=()=>{ $('newModal').classList.remove('show'); newNoteCore(false); };
$('newWithImages').onclick=()=>{ $('newModal').classList.remove('show'); newNoteCore(true); };
$('closeNew').onclick=()=>$('newModal').classList.remove('show');

$('saveRun').onclick=()=>saveSession();
$('newFromHome').onclick=newNote;
$('goHome1').onclick=()=>{ show('home'); renderHome(); };
$('goHome2').onclick=()=>{ show('home'); renderHome(); };
$('backToEdit').onclick=()=>{ show('edit'); };
$('genBtn').onclick=()=> startQuiz(false);
$('saveBtn').onclick=saveNote;

if(!localStorage.getItem('notes_index')) setIndex([]);
renderHome();
show('home');

})(); // IIFE
</script>
</body>
</html>
