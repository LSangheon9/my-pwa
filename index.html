<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>Mint</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
:root{
  --bg:#0b0f14; --panel:#0f141b; --text:#eef3ff; --muted:#9aa5b1; --bd:#1a2230;
  --acc:#5f96ff; --acc2:#b486ff; --ok:#2ddaa5; --bad:#ff6d7a; --chip:#121a24; --chipbd:#223047;
}
*{box-sizing:border-box; min-width:0}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
     font:15.5px/1.95 -apple-system,system-ui,"Noto Sans KR","Malgun Gothic",Roboto,Arial;
     -webkit-text-size-adjust:100%; max-width:100vw}
a{color:#9fbaff; text-decoration:none}
.wrap{max-width:920px;margin:0 auto;padding:14px}
.panel{background:var(--panel);border:1px solid var(--bd);border-radius:14px;padding:12px}
.titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.blogo{width:14px;height:14px;border-radius:6px;background:conic-gradient(from 180deg,var(--acc),var(--acc2),var(--acc))}
.btn{background:linear-gradient(180deg,var(--acc),var(--acc2));color:#fff;border:0;border-radius:12px;
     padding:9px 12px;font-size:14px;font-weight:800;min-height:36px;cursor:pointer; white-space:nowrap}
.btn.ghost{background:transparent;color:#9fbaff;border:1px solid var(--chipbd)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input[type="text"],input[type="password"],select{background:var(--chip);color:var(--text);border:1px solid var(--chipbd);
   border-radius:12px;padding:9px 12px;font-size:14px;outline:none;min-width:0}
textarea{width:100%;height:240px;background:var(--chip);color:var(--text);border:1px solid var(--chipbd);
   border-radius:12px;padding:12px;font-size:15.5px;font-family:"Noto Sans KR","Malgun Gothic",Roboto,Arial; line-height:1.9; white-space:pre-wrap}
.tiny{font-size:12px;color:var(--muted)}
.divider{height:1px;background:var(--bd);margin:14px 0}
.choices{display:grid; grid-template-columns:1fr 1fr; gap:8px}
@media (min-width:860px){ .choices{ grid-template-columns:1fr 1fr 1fr; } }
.chip{border:1px solid var(--chipbd);background:var(--chip);border-radius:12px;padding:9px 12px;
      font-size:15.5px;line-height:1.28; text-align:center; min-height:36px;
      white-space:nowrap; word-break:keep-all; overflow:hidden; text-overflow:ellipsis}
.chip.ok{border-color:var(--ok);box-shadow: inset 0 0 0 2px var(--ok)}
.chip.no{border-color:var(--bad);box-shadow: inset 0 0 0 2px var(--bad)}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--chipbd);
       padding:3px 8px;border-radius:999px;background:var(--chip);font-size:10.5px}
.dot{width:7px;height:7px;border-radius:999px;background:#777}
.okc{background:var(--ok)} .badc{background:var(--bad)}
.qwrap{display:flex;flex-direction:column;gap:8px}
.qtitle{font-weight:800;font-size:17px}
.qpassage{white-space:pre-wrap; line-height:2.05; letter-spacing:.05px; font-size:17px; border:1px solid var(--chipbd);
          background:var(--chip); border-radius:12px; padding:12px; height:36vh; overflow:auto}
.qpassage mark{background:transparent; color:#fff; border-bottom:3px solid var(--acc2); padding:0 2px}
.qfooter{display:flex;align-items:center;justify-content:space-between}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111a;color:#fff;border:1px solid var(--chipbd);
       border-radius:999px;padding:10px 16px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:9999}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
/* screens */
.screen{display:none}
.screen.show{display:block}
.list{display:grid; grid-template-columns:1fr; gap:10px}
.card{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--chipbd);background:var(--chip);
      border-radius:12px;padding:10px}
/* compact topbar on quiz screen */
.topbar{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.topbar .left{display:flex; gap:10px; align-items:center}
.topbtn{background:transparent;border:1px solid var(--chipbd);color:#9fbaff;border-radius:10px;padding:6px 10px; font-size:13px; white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">

  <!-- HOME -->
  <div id="home" class="screen show">
    <div class="panel">
      <div class="titlebar">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="blogo"></div>
          <b>Mint</b>
        </div>
        <button id="newFromHome" class="btn" type="button">+ New</button>
      </div>
      <div class="tiny">저장된 노트</div>
      <div id="homeList" class="list" style="margin-top:6px"></div>
      <div id="homeEmpty" class="tiny" style="color:#94a3b8;margin-top:8px">아직 저장된 노트가 없습니다.</div>
    </div>
  </div>

  <!-- EDIT -->
  <div id="edit" class="screen">
    <div class="panel">
      <div class="titlebar">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="goHome1" class="btn ghost" type="button">홈</button>
          <b id="brand">Mint</b>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="badge"><span id="gptDot" class="dot"></span><span id="gptTxt">GPT 꺼짐</span></span>
          <button id="deleteBtn" class="btn ghost" type="button">삭제</button>
          <button id="saveBtn" class="btn ghost" type="button">저장</button>
          <button id="genBtn" class="btn" type="button">생성</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <input id="title" type="text" placeholder="제목 입력(상단 바에는 표시만 됨)" style="min-width:220px;flex:1">
      </div>

      <textarea id="src" placeholder="텍스트를 붙여넣고 ‘생성’을 누르세요. (줄바꿈을 그대로 유지합니다)"></textarea>

      <div class="divider"></div>

      <!-- 설정 -->
      <div>
        <div class="row tiny"><label><input id="autoTune" type="checkbox" checked> 자동설정 (본문 길이 기반)</label></div>
        <div class="row tiny">최대 문제 수 <input id="holes" type="number" value="24" min="4" max="120" style="width:80px"> 개</div>
        <div class="row tiny">문장당 최대 빈칸 <input id="perSent" type="number" value="1" min="1" max="2" style="width:80px"> 개</div>
        <div class="row tiny">선택지 개수 <input id="nchoice" type="number" value="4" min="2" max="6" style="width:80px"> 개</div>
        <div class="row tiny">
          <label><input id="useLLM" type="checkbox"> ChatGPT 사용 (맥락 강화)</label>
          <input id="llmKey" type="password" placeholder="OpenAI API 키" style="flex:1; min-width:220px">
          <select id="llmModel">
            <option value="gpt-4.1-mini">gpt-4.1-mini</option>
            <option value="gpt-4o-mini">gpt-4o-mini</option>
          </select>
        </div>
        <div id="autoNote" class="tiny" style="color:#94a3b8"></div>
      </div>

      <div class="divider"></div>

      <!-- 미리보기 -->
      <div class="qwrap">
        <div class="qtitle">문제 프리뷰</div>
        <div id="qpassagePreview" class="qpassage">여기에 빈칸 지문이 표시됩니다.</div>
        <div class="choices" id="choicesPreview"></div>
        <div class="qfooter tiny"><span id="diag">상태: 준비</span><span id="statsPreview"></span></div>
      </div>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="screen">
    <div class="panel">
      <div class="topbar">
        <div class="left">
          <button id="goHome2" class="topbtn" type="button">홈</button>
          <button id="backToEdit" class="topbtn" type="button">설정</button>
          <button id="saveRun" class="topbtn" type="button">진행 저장</button>
        </div>
        <b id="quizTitle">Mint</b>
      </div>
      <div class="qwrap">
        <div id="qpassage" class="qpassage"></div>
        <div class="choices" id="choices"></div>
        <div class="qfooter tiny"><span id="stats"></span><span id="progress"></span></div>
      </div>
    </div>
  </div>

</div>

<div id="toast" class="toast">완료</div>

<script>
(function(){
'use strict';
const $=id=>document.getElementById(id);
const screens={home:$('home'), edit:$('edit'), quiz:$('quiz')};
function show(name){ for(const k in screens){ screens[k].classList.toggle('show', k===name); } }

// ----- State -----
let RAW="", QUE=[], TOTAL=0, CORR=0, WRONG=[], currentId=null, sessionId=null;
const titleEl=$('title'), brand=$('brand'), quizTitle=$('quizTitle'), src=$('src');
const qpassage=$('qpassage'), qpassagePreview=$('qpassagePreview'), choices=$('choices'), choicesPreview=$('choicesPreview');
const stats=$('stats'), progress=$('progress'), statsPreview=$('statsPreview'), diag=$('diag');
const gptDot=$('gptDot'), gptTxt=$('gptTxt');
function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1100); }
function setDiag(t){ diag.textContent='상태: '+t; }
function updateGPTBadge(){const on=$('useLLM').checked && !!$('llmKey').value.trim(); gptDot.className='dot '+(on?'okc':'badc'); gptTxt.textContent=on?'GPT 켜짐':'GPT 꺼짐';}
$('useLLM').addEventListener('change',updateGPTBadge); $('llmKey').addEventListener('input',updateGPTBadge); updateGPTBadge();

// ----- Home List -----
function getIndex(){ try{ return JSON.parse(localStorage.getItem('notes_index')||'[]')||[]; }catch(e){ return []; } }
function setIndex(arr){ localStorage.setItem('notes_index', JSON.stringify(arr||[])); }
function renderHome(){
  const list=$('homeList'), empty=$('homeEmpty');
  const idx=getIndex().sort((a,b)=>(b.updated||b.created)-(a.updated||a.created));
  list.innerHTML='';
  if(!idx.length){ empty.style.display='block'; } else { empty.style.display='none'; }
  idx.forEach(n=>{
    const card=document.createElement('div'); card.className='card';
    const badge = hasSession(n.id) ? ' <span class="tiny" style="color:#9fbaff">(이어하기 있음)</span>' : '';
    const m=document.createElement('div'); m.innerHTML=`<b>${escapeHtml(n.title||'(제목 없음)')}</b>${badge}<div class="tiny">${new Date(n.updated||n.created).toLocaleString()} · ${n.size||0}자</div>`;
    const a=document.createElement('div'); a.style.display='flex'; a.style.gap='6px';
    const open=document.createElement('button'); open.className='btn ghost'; open.textContent='열기'; open.onclick=()=>openNote(n.id);
    const cont=document.createElement('button'); cont.className='btn ghost'; cont.textContent='이어하기'; cont.onclick=()=>resumeSession(n.id); cont.style.display= hasSession(n.id)?'inline-block':'none';
    const del=document.createElement('button'); del.className='btn ghost'; del.textContent='삭제'; del.onclick=()=>deleteNote(n.id);
    a.append(open,cont,del); card.append(m,a); list.append(card);
  });
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

// ----- Save / Open / Delete -----
function saveNote(){
  const title=titleEl.value.trim()||'(제목 없음)'; const content=src.value;
  if(!content.trim()){ alert('내용이 비어 있습니다.'); return; }
  let id=currentId; const now=Date.now(); if(!id){ id='n'+now+Math.random().toString(16).slice(2); currentId=id; }
  const rec={id,title,content,created:now,updated:now,size:content.length};
  localStorage.setItem('note_'+id, JSON.stringify(rec));
  const idx=getIndex().filter(x=>x.id!==id); idx.push({id,title,created:rec.created,updated:rec.updated,size:rec.size});
  setIndex(idx); toast('저장됨'); renderHome();
}
function deleteNote(id){
  if(!id){ alert('삭제할 항목이 없습니다.'); return; }
  if(!confirm('삭제할까요?')) return;
  localStorage.removeItem('note_'+id);
  localStorage.removeItem('cloze_wrong_'+id);
  localStorage.removeItem('session_'+id);
  const idx=getIndex().filter(x=>x.id!==id); setIndex(idx);
  if(currentId===id){ currentId=null; titleEl.value=''; src.value=''; }
  renderHome(); toast('삭제됨');
}
function openNote(id){
  const rec=JSON.parse(localStorage.getItem('note_'+id)||'null');
  if(!rec){ alert('노트를 찾을 수 없습니다.'); return; }
  currentId=id; titleEl.value=rec.title||''; src.value=rec.content||'';
  RAW=""; QUE=[]; TOTAL=0; CORR=0; WRONG=[];
  brand.textContent=rec.title||'Mint'; quizTitle.textContent=brand.textContent;
  qpassagePreview.textContent='여기에 빈칸 지문이 표시됩니다.'; choicesPreview.innerHTML=''; statsPreview.textContent='';
  setDiag('노트 로드됨'); show('edit');
}
$('deleteBtn').onclick=()=>{ if(currentId){ deleteNote(currentId); show('home'); } else { alert('현재 노트가 없습니다.'); } };

// ----- Session (autosave/restore) -----
function makeSessionId(){
  if(currentId) return 'session_'+currentId;
  // unsaved: derive from title+content hash
  const t=(titleEl.value||'').slice(0,64), c=(src.value||'').slice(0,256);
  let h=0, s=t+'|'+c; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return 'session_tmp_'+(h>>>0);
}
function hasSession(noteId){
  const key='session_'+noteId;
  return !!localStorage.getItem(key);
}
function saveSession(){
  if(!RAW || !QUE) return;
  sessionId = makeSessionId();
  const payload={ id:sessionId, noteId:currentId||null, title:titleEl.value||'Mint', raw:RAW, que:QUE, total:TOTAL, corr:CORR,
                  nchoice:+$('nchoice').value||4, ts:Date.now() };
  try{ localStorage.setItem(sessionId, JSON.stringify(payload)); toast('진행 저장됨'); }catch(e){}
}
function clearSession(){
  if(!sessionId) sessionId=makeSessionId();
  localStorage.removeItem(sessionId);
}
function tryResumePrompt(){
  const key=currentId? 'session_'+currentId : makeSessionId();
  const s=localStorage.getItem(key);
  if(!s) return false;
  if(confirm('이전에 진행하던 문제가 있습니다. 이어서 할까요?')){
    const payload=JSON.parse(s);
    RAW=payload.raw; QUE=payload.que||[]; TOTAL=payload.total||0; CORR=payload.corr||0;
    brand.textContent=payload.title||'Mint'; quizTitle.textContent=brand.textContent;
    show('quiz'); renderNext(); setTimeout(()=>toast('이어하기 로드됨'), 10);
    return true;
  }
  return false;
}
function resumeSession(noteId){
  const s=localStorage.getItem('session_'+noteId);
  if(!s){ alert('이어할 세션이 없습니다.'); return; }
  const payload=JSON.parse(s);
  currentId=noteId;
  titleEl.value=payload.title||''; src.value=payload.raw||'';
  RAW=payload.raw; QUE=payload.que||[]; TOTAL=payload.total||0; CORR=payload.corr||0;
  brand.textContent=payload.title||'Mint'; quizTitle.textContent=brand.textContent;
  show('quiz'); renderNext(); toast('이어하기 로드됨');
}

// ===== Cloze Engine (v28b logic 유지: 5W1H + 문장 커버리지) =====
const STOP=new Set((`가 각 또한 그리고 그러나 그래서 그런데 또는 및 즉 따라서 하지만 이는 이를 이가 그의 그녀 그들
은 는 이 가 을 를 의 에 에서 으로 와 과 도 만 보다 처럼 대해 대한 대해서 등이 등등 있다 없다 하다 되다 a an the and or but so of to in on at for with from by as is are was were be been being this that those these it its their them they he she we you`).trim().split(/\s+/));
const JOSA=['으로써','으로서','이지만','지만','이라도','라도','이나','나','이며','에서','에게','께서','부터','까지','처럼','보다','만큼','조차','마저','밖에','으로','로','이고','이며','과','와','을','를','은','는','이','가','의','도','만','랑','하고','동안','후에','이후','이전에','때','동안에'];
const MARKERS=['에서','동안','이후','이전에','후에','초기에','말기에','때','때에','을 통해','를 통해','함으로써','하여','방법으로','먼저','우선','다음','그리고 나서','마지막으로','결국','때문에','따라서','그래서','그 결과','결과적으로','으로 인해','로 인해','위해','목적','이유','원인'];
const WHO_SUFFIX=['팀','기관','위원회','정부','회사','학자','연구소','교수','박사','학생','세포','효소','단백질','유전자','염색체','기관','조직','장기','핵','막','세균','바이러스'];
const TIME_HINT=/\b(\d{1,4}\s*(년|월|일|시|분))\b|초기|말기|중기|봄|여름|가을|겨울/;
const METHOD_HINT=/방법|방식|절차|기법|경로|수단/;
const PROC=/진행|형성|발생|거쳐|포함|구성|조절|촉진|억제|전달|분해|합성|변환|흡수|배출|분열|결합|작용|영향|유발|개시|종결/;

function stripPunct(t){return t.replace(/^[\s\"'“”‘’()\[\]{},.?!;:]+|[\s\"'“”‘’()\[\]{},.?!;:]+$/g,'');}
function stripJosa(w){let t=stripPunct(w); for(const s of JOSA.sort((a,b)=>b.length-a.length)){ if(t.length>s.length && t.endsWith(s)) { t=t.slice(0,-s.length); break; } } return t;}
function sentencesIdx(text){
  const seps=/[\.?!\n\r。！？…]/g; const idxs=[0]; let m;
  while((m=seps.exec(text))){ idxs.push(m.index+1); }
  idxs.push(text.length);
  const out=[]; for(let i=0;i<idxs.length-1;i++){ out.push([idxs[i], idxs[i+1]]); } return out;
}
function tokenizePositions(text){
  const tokens=[]; const re=/[^\s]+/g; let m;
  while((m=re.exec(text))){
    const raw=m[0], start=m.index; const base=stripJosa(raw);
    const k=base.toLowerCase(); if(!base || base.length<2) continue; if(/\d/.test(k)) continue; if(STOP.has(k)) continue;
    tokens.push({raw, base, start, end:start+raw.length});
  }
  return tokens;
}
function scoreToken(text, tok){
  let s=0;
  const L=120, R=140, st=Math.max(0,tok.start-L), en=Math.min(text.length, tok.end+R);
  const ctx=text.slice(st,en);
  if(MARKERS.some(m=>ctx.includes(m))) s+=1.4;
  if(TIME_HINT.test(ctx)) s+=0.7;
  if(METHOD_HINT.test(ctx)) s+=0.6;
  if(/위해|목적|이유|원인|때문/.test(ctx)) s+=0.9;
  if(PROC.test(ctx)) s+=0.8;
  if(/[이가은는을를]$/.test(tok.raw)) s+=0.45;
  if(WHO_SUFFIX.some(suf=>tok.base.endsWith(suf))) s+=0.55;
  const prevNL=text.lastIndexOf('\n', tok.start); const head=text.slice(prevNL+1, tok.start);
  if(/^\s*(\d{1,3}[\.|)]|\([0-9]{1,3}\)|[A-Za-z][\.|)]|\([A-Za-z]\))/.test(head)) s+=0.5;
  if(/[A-Z]/.test(tok.base)) s+=0.35;
  s += Math.min(1.2, tok.base.length*0.08);
  return s;
}
function buildItems(text, targetCount, maxPerSentence, nChoice){
  const toks=tokenizePositions(text);
  const scored=toks.map(t=>({...t,score:scoreToken(text,t)})).sort((a,b)=>b.score-a.score || a.start-b.start);
  const sents=sentencesIdx(text);
  function sentBucket(pos){ let i=0; while(i<sents.length && pos>=sents[i][1]) i++; return i; }
  const per=new Map(), picks=[];
  for(const t of scored){
    const b=sentBucket(t.start); const c=per.get(b)||0;
    if(c>=maxPerSentence) continue;
    picks.push(t); per.set(b,c+1);
    if(picks.length>=Math.max(targetCount*2, targetCount+6)) break;
  }
  picks.sort((a,b)=>a.start-b.start);
  const seenPos=new Set(); const final=[];
  for(const p of picks){
    const key=p.start+'@'+p.end; if(seenPos.has(key)) continue; seenPos.add(key);
    final.push({answer:p.base, pos:p.start, len:p.base.length, rawSpan:[p.start,p.end]});
    if(final.length>=targetCount) break;
  }
  // Ensure coverage: at least one blank per sentence
  const hasBySentence=new Map();
  final.forEach(it=>{ const b=sentBucket(it.pos); hasBySentence.set(b, (hasBySentence.get(b)||0)+1); });
  for(let si=0; si<sents.length; si++){
    if(!hasBySentence.get(si)){
      const [s,e]=sents[si];
      const cand=scored.find(t=> t.start>=s && t.start<e && !final.find(f=>f.pos===t.start));
      if(cand){
        final.push({answer:cand.base, pos:cand.start, len:cand.base.length, rawSpan:[cand.start,cand.end]});
        hasBySentence.set(si,1);
      }
    }
  }
  // build distractors
  const bases=[...new Set(toks.map(t=>t.base))];
  function dsPool(ans){
    const al=ans.length;
    return bases.filter(b=>b!==ans && Math.abs(b.length-al)<=Math.max(2,Math.floor(al*0.4))).slice(0,30);
  }
  const items=final.map(it=>{
    const pool=dsPool(it.answer).sort(()=>Math.random()-0.5);
    return {...it, distractors: pool.slice(0, Math.max(1, nChoice-1))};
  });
  return items;
}

// ----- Quiz Flow -----
function renderInto(container, raw, item){
  const before=raw.slice(0, item.pos);
  const after=raw.slice(item.pos+item.len);
  container.innerHTML = escapeHtml(before) + '<mark>____</mark>' + escapeHtml(after);
  const mark=container.querySelector('mark');
  if(mark){ const top=mark.offsetTop - container.clientHeight/2 + 30; container.scrollTo({top: Math.max(0, top), behavior:'instant'}); }
}
function renderChoices(container, item, nChoice, onPick){
  container.innerHTML='';
  const opts=[item.answer, ...item.distractors].sort(()=>Math.random()-0.5).slice(0, Math.max(2,nChoice));
  for(const opt of opts){
    const el=document.createElement('div'); el.className='chip'; el.textContent=opt;
    el.onclick=()=>{
      if(opt===item.answer){ el.classList.add('ok'); }
      else{
        el.classList.add('no');
        [...container.children].forEach(n=>{ if(n.textContent===item.answer) n.classList.add('ok'); });
      }
      setTimeout(()=>onPick(opt===item.answer), 160);
    };
    container.appendChild(el);
  }
}
function startQuiz(wrongOnly=false){
  const text=src.value.trim(); if(!text){ alert('텍스트를 넣어주세요.'); return; }
  RAW=text; TOTAL=0; CORR=0; WRONG=[];
  const title=titleEl.value.trim()||'Mint'; brand.textContent=title; quizTitle.textContent=title;
  sessionId=null;
  // resume prompt if session exists
  if(tryResumePrompt()) return;

  const maxPerSentence = Math.max(1, Math.min(2, +$('perSent').value||1));
  const hardMax = Math.max(4, Math.min(120, +$('holes').value||24));
  const nChoice = Math.max(2, Math.min(6, +$('nchoice').value||4));

  setDiag('문항 구성…');
  let items = buildItems(RAW, hardMax, maxPerSentence, nChoice);
  QUE = items;
  if(!QUE.length){ alert('만들 수 있는 문항이 없습니다.'); return; }

  // preview
  renderInto(qpassagePreview, RAW, QUE[0]);
  renderChoices(choicesPreview, QUE[0], nChoice, ()=>{});
  document.getElementById('statsPreview').textContent=`미리보기 · 총 ${QUE.length}문항`;

  show('quiz'); renderNext();
}
function renderNext(){
  const choices=document.getElementById('choices');
  const stats=document.getElementById('stats');
  const progress=document.getElementById('progress');
  choices.innerHTML=''; stats.textContent=''; progress.textContent='';
  if(!QUE.length){
    document.getElementById('qpassage').innerHTML='<b>끝!</b>'; stats.textContent=`점수 ${CORR}/${TOTAL}`; clearSession(); return;
  }
  const cur=QUE[0];
  renderInto(document.getElementById('qpassage'), RAW, cur);
  renderChoices(choices, cur, Math.max(2, +document.getElementById('nchoice').value||4), (correct)=>{
    TOTAL++; if(correct) CORR++; else WRONG.push(cur);
    QUE.shift(); updateProg(); saveSession(); renderNext();
  });
  updateProg(); saveSession();
}
function updateProg(){ document.getElementById('progress').textContent=`${TOTAL+1}/${TOTAL+QUE.length} · 점수 ${CORR}`; }

// ----- Navigation -----
function newNote(){
  currentId=null; titleEl.value=''; src.value=''; RAW=""; QUE=[]; TOTAL=0; CORR=0; WRONG=[]; sessionId=null;
  qpassagePreview.textContent='여기에 빈칸 지문이 표시됩니다.'; choicesPreview.innerHTML=''; statsPreview.textContent='';
  brand.textContent='Mint'; quizTitle.textContent='Mint'; setDiag('새 노트');
  show('edit');
}
// manual save progress button
document.getElementById('saveRun').onclick=()=>saveSession();

// wiring
document.getElementById('newFromHome').onclick=newNote;
document.getElementById('goHome1').onclick=()=>{ show('home'); renderHome(); };
document.getElementById('goHome2').onclick=()=>{ show('home'); renderHome(); };
document.getElementById('backToEdit').onclick=()=>{ show('edit'); };
document.getElementById('genBtn').onclick=()=> startQuiz(false);
document.getElementById('saveBtn').onclick=saveNote;

if(!localStorage.getItem('notes_index')) setIndex([]);
renderHome();
show('home');

// utils
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
})();
</script>
</body>
</html>
